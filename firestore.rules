rules_version = '2';
service cloud.firestore {
  match /databases/{database}/documents {
    
    // 헬퍼 함수: 인증된 사용자인지 확인
    function isAuthenticated() {
      return request.auth != null;
    }
    
    // 헬퍼 함수: 사용자 문서 읽기 (자신의 문서 또는 공개 정보만)
    function getUserData(uid) {
      return get(/databases/$(database)/documents/users/$(uid)).data;
    }
    
    // 헬퍼 함수: 현재 사용자의 역할 확인
    function getCurrentUserRole() {
      return getUserData(request.auth.uid).role;
    }
    
    // 헬퍼 함수: 역할이 특정 역할인지 확인
    function hasRole(role) {
      return isAuthenticated() && getCurrentUserRole() == role;
    }
    
    // 헬퍼 함수: 캠페인 소유자인지 확인
    function isCampaignOwner(campaignId) {
      return isAuthenticated() && 
             get(/databases/$(database)/documents/campaigns/$(campaignId)).data.advertiserId == request.auth.uid;
    }
    
    // 헬퍼 함수: 인플루언서가 지원했는지 확인
    function hasApplied(campaignId) {
      let applications = get(/databases/$(database)/documents/campaigns/$(campaignId)/applications/$(request.auth.uid));
      return applications.exists;
    }
    
    // ========================================
    // users 컬렉션
    // ========================================
    match /users/{userId} {
      // 자신의 프로필은 읽기/쓰기 가능
      allow read: if isAuthenticated() && (request.auth.uid == userId || hasRole('admin'));
      
      // 자신의 프로필은 업데이트 가능 (role 변경 제외)
      allow create, update: if isAuthenticated() && request.auth.uid == userId &&
        (!('role' in request.resource.data.diff(resource.data).affectedKeys()) || 
         request.resource.data.role == resource.data.role);
      
      // Admin은 모든 사용자 정보 업데이트 가능
      allow update: if hasRole('admin');
      
      // 회원가입 시 자신의 문서 생성 허용
      allow create: if isAuthenticated() && request.auth.uid == userId;
    }
    
    // ========================================
    // campaigns 컬렉션
    // ========================================
    match /campaigns/{campaignId} {
      // 광고주: 자신의 캠페인 읽기/쓰기
      allow read: if isAuthenticated() && (
        isCampaignOwner(campaignId) ||
        hasRole('admin') ||
        // 인플루언서: OPEN 상태인 캠페인만 읽기 가능
        (hasRole('influencer') && resource.data.status == 'OPEN')
      );
      
      // 광고주: 자신의 캠페인 생성/업데이트
      allow create: if isAuthenticated() && hasRole('advertiser') &&
        request.resource.data.advertiserId == request.auth.uid;
      
      allow update: if isAuthenticated() && (
        isCampaignOwner(campaignId) ||
        hasRole('admin')
      );
      
      // ========================================
      // campaigns/{campaignId}/specs
      // ========================================
      match /specs/{specId} {
        // 캠페인 읽기 권한이 있으면 spec도 읽기 가능
        allow read: if isAuthenticated() && (
          isCampaignOwner(campaignId) ||
          hasRole('admin') ||
          (hasRole('influencer') && get(/databases/$(database)/documents/campaigns/$(campaignId)).data.status == 'OPEN')
        );
        
        // 광고주/Admin만 생성/업데이트
        allow create, update: if isAuthenticated() && (
          isCampaignOwner(campaignId) ||
          hasRole('admin')
        );
      }
      
      // ========================================
      // campaigns/{campaignId}/applications
      // ========================================
      match /applications/{applicationId} {
        // 광고주: 자신의 캠페인 지원 목록 읽기
        // 인플루언서: 자신의 지원 내역 읽기
        // Admin: 모든 지원 내역 읽기
        allow read: if isAuthenticated() && (
          isCampaignOwner(campaignId) ||
          (hasRole('influencer') && resource.data.influencerId == request.auth.uid) ||
          hasRole('admin')
        );
        
        // 인플루언서: 자신의 지원만 생성 가능 (OPEN 상태인 캠페인에만)
        allow create: if isAuthenticated() && hasRole('influencer') &&
          request.resource.data.influencerId == request.auth.uid &&
          request.resource.data.campaignId == campaignId &&
          get(/databases/$(database)/documents/campaigns/$(campaignId)).data.status == 'OPEN';
        
        // 광고주/Admin: 지원 상태 업데이트 (선정/거절)
        allow update: if isAuthenticated() && (
          isCampaignOwner(campaignId) ||
          hasRole('admin')
        );
      }
      
      // ========================================
      // campaigns/{campaignId}/submissions
      // ========================================
      match /submissions/{submissionId} {
        // 광고주: 자신의 캠페인 제출물 읽기
        // 인플루언서: 자신의 제출물 읽기
        // Admin: 모든 제출물 읽기
        allow read: if isAuthenticated() && (
          isCampaignOwner(campaignId) ||
          (hasRole('influencer') && resource.data.influencerId == request.auth.uid) ||
          hasRole('admin')
        );
        
        // 인플루언서: 자신의 제출만 생성/업데이트
        // (선정된 인플루언서만 제출 가능)
        allow create, update: if isAuthenticated() && hasRole('influencer') &&
          request.resource.data.influencerId == request.auth.uid &&
          request.resource.data.campaignId == campaignId &&
          // 선정 여부는 서버에서 검증 (권한 규칙에서는 기본 체크만)
          exists(/databases/$(database)/documents/campaigns/$(campaignId)/applications/$(request.auth.uid));
        
        // 광고주/Admin: 제출 상태 업데이트 (승인/수정요청)
        allow update: if isAuthenticated() && (
          isCampaignOwner(campaignId) ||
          hasRole('admin')
        );
      }
      
      // ========================================
      // campaigns/{campaignId}/reports
      // ========================================
      match /reports/{reportId} {
        // 광고주: 자신의 캠페인 리포트 읽기
        // Admin: 모든 리포트 읽기
        allow read: if isAuthenticated() && (
          isCampaignOwner(campaignId) ||
          hasRole('admin')
        );
        
        // 시스템/Admin만 리포트 생성 가능
        allow create: if isAuthenticated() && (
          request.resource.data.generatedBy == 'system' ||
          hasRole('admin')
        );
      }
    }
    
    // ========================================
    // events 컬렉션 (감사 로그)
    // ========================================
    match /events/{eventId} {
      // 모든 인증된 사용자가 읽기 가능 (자신과 관련된 이벤트 필터링은 클라이언트에서)
      allow read: if isAuthenticated();
      
      // 서버(Admin SDK)만 생성 가능 (클라이언트에서 직접 생성 불가)
      // 실제로는 API 라우트에서만 생성하므로, 여기서는 읽기만 허용
      allow create: if false; // 클라이언트 직접 생성 금지
      allow update, delete: if false; // 이벤트는 불변
    }
    
    // ========================================
    // penalties 컬렉션
    // ========================================
    match /penalties/{penaltyId} {
      // 인플루언서: 자신의 페널티 읽기
      // 광고주: 자신의 캠페인 관련 페널티 읽기
      // Admin: 모든 페널티 읽기
      allow read: if isAuthenticated() && (
        (hasRole('influencer') && resource.data.influencerId == request.auth.uid) ||
        (hasRole('advertiser') && isCampaignOwner(resource.data.campaignId)) ||
        hasRole('admin')
      );
      
      // Admin만 생성/업데이트
      allow create, update: if hasRole('admin');
    }
  }
}

